<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <title>System Status</title>
    {% if refresh_seconds > 0 %}
    <meta http-equiv="refresh" content="{{ refresh_seconds }}">
    {% endif %}
    <link rel="stylesheet" href="https://unpkg.com/@tabler/core@1.0.0-beta21/dist/css/tabler.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.52.0"></script>
    <script src="https://unpkg.com/@tabler/core@1.0.0-beta21/dist/js/tabler.min.js"></script>
    <style>
      .chart {
        width: 100%;
        height: 240px;
        background: var(--tblr-body-bg, #0b0f14);
        border-radius: 6px;
      }
      .chart-legend {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        display: inline-block;
      }
      .legend-label {
        font-size: 12px;
        color: #9aa3ab;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="page-wrapper">
        <div class="container-xl">
          <div class="page-header d-print-none">
            <div class="row align-items-center">
              <div class="col">
                <a class="text-secondary" href="{{ base_path }}/">&#8592; Back to runs</a>
                <h2 class="page-title">System Status</h2>
                <div class="text-secondary">Host + process utilization and load averages.</div>
              </div>
              <div class="col-auto">
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-yellow text-dark d-none" id="livePausedBadge">Live paused</span>
                  <button class="btn btn-outline-warning btn-sm d-none" id="resumeLiveBtn" type="button">
                    Resume live
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="page-body">
            <div class="row row-cards">
              <div class="col-12 col-md-3">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Host CPU</div>
                    <div class="h2 m-0" id="hostCpu">{{ summary.host_cpu }}%</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-3">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Server CPU</div>
                    <div class="h2 m-0" id="procCpu">{{ summary.proc_cpu }}%</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-3">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Child processes CPU</div>
                    <div class="h2 m-0" id="childrenCpu">{{ summary.children_cpu }}%</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-3">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Total CPU</div>
                    <div class="h2 m-0" id="totalCpu">{{ summary.total_cpu }}%</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Host Memory</div>
                    <div class="h3 m-0" id="hostMem">{{ summary.host_mem_used_mb }} / {{ summary.host_mem_total_mb }} MB</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Server Memory</div>
                    <div class="h3 m-0" id="procMem">{{ summary.proc_mem_mb }} MB</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Child processes Memory</div>
                    <div class="h3 m-0" id="childrenMem">{{ summary.children_mem_mb }} MB</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Total Memory</div>
                    <div class="h3 m-0" id="totalMem">{{ summary.total_mem_mb }} MB</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Running Jobs</div>
                    <div class="h2 m-0" id="runningJobs">{{ summary.running_jobs }}</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Queued Jobs</div>
                    <div class="h2 m-0" id="queuedJobs">{{ summary.queued_jobs }}</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Concurrency Limit</div>
                    <div class="h2 m-0" id="jobLimit">
                      {% if summary.max_concurrent_jobs.is_some() %}
                        {{ summary.max_concurrent_jobs.unwrap() }}
                      {% else %}
                        Unlimited
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="card">
                  <div class="card-body">
                    <div class="text-secondary">Load 1 / 5 / 15</div>
                    <div class="h2 m-0" id="loadAvg">{{ summary.load1 }} / {{ summary.load5 }} / {{ summary.load15 }}</div>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <div class="card-title">CPU Usage (last 10 min)</div>
                  </div>
                  <div class="card-body">
                    <div class="chart-legend mb-2">
                      <span class="legend-dot" style="background:#4dabf7"></span>
                      <span class="legend-label">Server CPU</span>
                      <span class="legend-dot" style="background:#ffd43b"></span>
                      <span class="legend-label">Child processes CPU</span>
                      <span class="legend-dot" style="background:#69db7c"></span>
                      <span class="legend-label">Total CPU</span>
                    </div>
                    <div id="cpuChart" class="chart"></div>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <div class="card-title">Host vs Total CPU (last 10 min)</div>
                  </div>
                  <div class="card-body">
                    <div class="chart-legend mb-2">
                      <span class="legend-dot" style="background:#4dabf7"></span>
                      <span class="legend-label">Host CPU</span>
                      <span class="legend-dot" style="background:#69db7c"></span>
                      <span class="legend-label">Total CPU</span>
                    </div>
                    <div id="cpuTotalChart" class="chart"></div>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <div class="card-title">Memory (last 10 min)</div>
                  </div>
                  <div class="card-body">
                    <div class="chart-legend mb-2">
                      <span class="legend-dot" style="background:#4dabf7"></span>
                      <span class="legend-label">Server MB</span>
                      <span class="legend-dot" style="background:#ffd43b"></span>
                      <span class="legend-label">Child processes MB</span>
                      <span class="legend-dot" style="background:#69db7c"></span>
                      <span class="legend-label">Total MB</span>
                      <span class="legend-dot" style="background:#ffa8a8"></span>
                      <span class="legend-label">Host Used MB</span>
                    </div>
                    <div id="memChart" class="chart"></div>
                  </div>
                </div>
              </div>
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <div class="card-title">Load Average (last 10 min)</div>
                  </div>
                  <div class="card-body">
                    <div class="chart-legend mb-2">
                      <span class="legend-dot" style="background:#74c0fc"></span>
                      <span class="legend-label">Load 1</span>
                      <span class="legend-dot" style="background:#c0eb75"></span>
                      <span class="legend-label">Load 5</span>
                      <span class="legend-dot" style="background:#ffa94d"></span>
                      <span class="legend-label">Load 15</span>
                    </div>
                    <div id="loadChart" class="chart"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      const basePath = "{{ base_path }}";
      const samples = [];
      const windowSeconds = 600;

      function trimSamples() {
        const cutoff = Math.floor(Date.now() / 1000) - windowSeconds;
        while (samples.length && samples[0].ts < cutoff) {
          samples.shift();
        }
      }

      function updateSummary(sample) {
        const toMb = (value) => value / 1024 / 1024;
        document.getElementById("hostCpu").textContent = `${sample.host_cpu.toFixed(1)}%`;
        document.getElementById("procCpu").textContent = `${sample.proc_cpu.toFixed(1)}%`;
        document.getElementById("childrenCpu").textContent = `${sample.children_cpu.toFixed(1)}%`;
        document.getElementById("totalCpu").textContent = `${sample.total_cpu.toFixed(1)}%`;
        document.getElementById("loadAvg").textContent =
          `${sample.load1.toFixed(2)} / ${sample.load5.toFixed(2)} / ${sample.load15.toFixed(2)}`;
        document.getElementById("hostMem").textContent =
          `${Math.round(toMb(sample.host_mem_used_kb))} / ${Math.round(toMb(sample.host_mem_total_kb))} MB`;
        document.getElementById("procMem").textContent =
          `${Math.round(toMb(sample.proc_mem_kb))} MB`;
        document.getElementById("childrenMem").textContent =
          `${Math.round(toMb(sample.children_mem_kb))} MB`;
        document.getElementById("totalMem").textContent =
          `${Math.round(toMb(sample.total_mem_kb))} MB`;
        document.getElementById("runningJobs").textContent = `${sample.running_jobs}`;
        document.getElementById("queuedJobs").textContent = `${sample.queued_jobs}`;
        const limitLabel = sample.max_concurrent_jobs === null || sample.max_concurrent_jobs === undefined
          ? "Unlimited"
          : sample.max_concurrent_jobs;
        document.getElementById("jobLimit").textContent = `${limitLabel}`;
      }

      let livePaused = false;
      const livePausedBadge = document.getElementById("livePausedBadge");
      const resumeLiveBtn = document.getElementById("resumeLiveBtn");

      function setLivePaused(value) {
        livePaused = value;
        if (!livePausedBadge || !resumeLiveBtn) {
          return;
        }
        if (value) {
          livePausedBadge.classList.remove("d-none");
          resumeLiveBtn.classList.remove("d-none");
        } else {
          livePausedBadge.classList.add("d-none");
          resumeLiveBtn.classList.add("d-none");
        }
      }

      if (resumeLiveBtn) {
        resumeLiveBtn.addEventListener("click", () => {
          setLivePaused(false);
          redraw();
        });
      }

      const tablerColors = {
        blue: tabler.getColor("blue"),
        yellow: tabler.getColor("yellow"),
        green: tabler.getColor("green"),
        red: tabler.getColor("red"),
        orange: tabler.getColor("orange"),
        cyan: tabler.getColor("cyan"),
        lime: tabler.getColor("lime"),
      };

      const baseChartOptions = {
        chart: {
          type: "line",
          height: 240,
          zoom: { enabled: true },
          toolbar: { show: true },
          animations: { enabled: false },
          background: "transparent",
          events: {
            zoomed: () => {
              setLivePaused(true);
            },
            beforeResetZoom: () => {
              setLivePaused(false);
            },
          },
        },
        theme: { mode: "dark" },
        stroke: { curve: "straight", width: 2 },
        markers: { size: 2 },
        grid: { borderColor: "rgba(255, 255, 255, 0.1)" },
        xaxis: { type: "datetime" },
        yaxis: { min: 0 },
        legend: { position: "bottom" },
        tooltip: { x: { format: "HH:mm:ss" }, theme: "dark" },
      };

      const cpuChart = new ApexCharts(document.getElementById("cpuChart"), {
        ...baseChartOptions,
        colors: [tablerColors.blue, tablerColors.yellow, tablerColors.green],
        yaxis: { min: 0, max: 100 },
        series: [],
      });
      cpuChart.render();

      const cpuTotalChart = new ApexCharts(document.getElementById("cpuTotalChart"), {
        ...baseChartOptions,
        colors: [tablerColors.cyan, tablerColors.green],
        yaxis: { min: 0, max: 100 },
        series: [],
      });
      cpuTotalChart.render();

      const memChart = new ApexCharts(document.getElementById("memChart"), {
        ...baseChartOptions,
        colors: [tablerColors.blue, tablerColors.yellow, tablerColors.green, tablerColors.red],
        series: [],
      });
      memChart.render();

      const loadChart = new ApexCharts(document.getElementById("loadChart"), {
        ...baseChartOptions,
        colors: [tablerColors.cyan, tablerColors.lime, tablerColors.orange],
        series: [],
      });
      loadChart.render();

      function buildSeries() {
        const cpuSeries = [
          {
            name: "Server CPU",
            data: samples.map((s) => ({ x: s.ts * 1000, y: s.proc_cpu })),
          },
          {
            name: "Child processes CPU",
            data: samples.map((s) => ({ x: s.ts * 1000, y: s.children_cpu })),
          },
          {
            name: "Total CPU",
            data: samples.map((s) => ({ x: s.ts * 1000, y: s.total_cpu })),
          },
        ];
        const cpuTotalSeries = [
          {
            name: "Host CPU",
            data: samples.map((s) => ({ x: s.ts * 1000, y: s.host_cpu })),
          },
          {
            name: "Total CPU",
            data: samples.map((s) => ({ x: s.ts * 1000, y: s.total_cpu })),
          },
        ];
        const toMb = (value) => value / 1024 / 1024;
        const memSeries = [
          {
            name: "Server MB",
            data: samples.map((s) => ({ x: s.ts * 1000, y: toMb(s.proc_mem_kb) })),
          },
          {
            name: "Child processes MB",
            data: samples.map((s) => ({ x: s.ts * 1000, y: toMb(s.children_mem_kb) })),
          },
          {
            name: "Total MB",
            data: samples.map((s) => ({ x: s.ts * 1000, y: toMb(s.total_mem_kb) })),
          },
          {
            name: "Host Used MB",
            data: samples.map((s) => ({ x: s.ts * 1000, y: toMb(s.host_mem_used_kb) })),
          },
        ];
        const loadSeries = [
          {
            name: "Load 1",
            data: samples.map((s) => ({ x: s.ts * 1000, y: s.load1 })),
          },
          {
            name: "Load 5",
            data: samples.map((s) => ({ x: s.ts * 1000, y: s.load5 })),
          },
          {
            name: "Load 15",
            data: samples.map((s) => ({ x: s.ts * 1000, y: s.load15 })),
          },
        ];
        return { cpuSeries, cpuTotalSeries, memSeries, loadSeries };
      }

      function redraw() {
        trimSamples();
        if (samples.length) {
          updateSummary(samples[samples.length - 1]);
        }
        const series = buildSeries();
        if (!livePaused) {
          cpuChart.updateSeries(series.cpuSeries, true);
          cpuTotalChart.updateSeries(series.cpuTotalSeries, true);
          memChart.updateSeries(series.memSeries, true);
          loadChart.updateSeries(series.loadSeries, true);
        }
      }

      fetch(`${basePath}/status/snapshot`)
        .then((response) => response.json())
        .then((data) => {
          if (Array.isArray(data)) {
            samples.push(...data);
            redraw();
          }
        })
        .catch(() => {});

      const source = new EventSource(`${basePath}/status/stream`);
      source.onmessage = (event) => {
        try {
          const sample = JSON.parse(event.data);
          samples.push(sample);
          redraw();
        } catch (err) {
          console.log("Invalid metrics event", err);
        }
      };
    </script>
  </body>
</html>
