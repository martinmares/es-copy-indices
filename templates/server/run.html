{% extends "server/layout.html" %}

{% block title %}Run {{ run.id }} · ES Copy Runner{% endblock %}

{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.52.0"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/material-darker.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/dialog/dialog.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/toml/toml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/search/searchcursor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/search/search.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/dialog/dialog.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/search/jump-to-line.js"></script>
{% endblock %}

{% block styles %}
  <style>
    .status-text {
      font-weight: 600;
    }
    .split-query {
      background: #000;
      color: #cfe3f4;
      padding: 8px;
      border-radius: 6px;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .split-query-wrap {
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }
    .split-query-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      background: rgba(255, 255, 255, 0.04);
    }
    .split-query {
      margin: 0;
      border-radius: 0;
    }
    details.split-details > summary {
      cursor: pointer;
      list-style: none;
      padding: 8px 0;
      font-weight: 600;
    }
    details.split-details > summary::before {
      content: "›";
      display: inline-block;
      margin-right: 8px;
      transform: translateY(-1px);
    }
    details.split-details[open] > summary::before {
      content: "⌄";
    }
    .split-chart {
      background: var(--tblr-body-bg, #0b0f14);
      border-radius: 6px;
      padding: 6px;
    }
    .config-editor-list {
      max-height: 520px;
      overflow: auto;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      padding: 4px;
    }
    .config-file-item {
      width: 100%;
      text-align: left;
      border: 0;
      background: transparent;
      color: #e6edf7;
      font-weight: 600;
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    .config-file-item:hover {
      background: rgba(255, 255, 255, 0.06);
    }
    .config-file-item.active {
      background: rgba(59, 130, 246, 0.25);
      color: #ffffff;
    }
    .config-editor-list .list-group-item {
      cursor: pointer;
    }
    .config-editor-list .list-group-item.active {
      background: rgba(74, 144, 226, 0.2);
      border-color: rgba(74, 144, 226, 0.6);
      color: #dbeafe;
    }
    .config-editor-pane {
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      overflow: hidden;
    }
    #configEditorModal .config-editor-pane .CodeMirror {
      height: 100%;
    }
    #configEditorModal .modal-dialog {
      max-width: 90vw;
    }
    #configEditorModal .modal-content {
      height: 92vh;
    }
    #configEditorModal .modal-body {
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #configEditorModal .modal-body .row {
      flex: 1 1 auto;
      min-height: 0;
    }
    #configEditorModal .config-editor-list,
    #configEditorModal .config-editor-pane {
      height: 100%;
      min-height: 0;
    }
  </style>
{% endblock %}

{% block header %}
  <div class="page-header d-print-none">
    <div class="row align-items-center">
      <div class="col">
        <ol class="breadcrumb breadcrumb-arrows" aria-label="breadcrumbs">
          <li class="breadcrumb-item">
            <a href="{{ base_path }}/">Dashboard</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            Run {{ run.id }}
          </li>
        </ol>
        <div class="text-secondary">Created at {{ run.created_at }}</div>
      </div>
      <div class="col-auto">
        <div class="btn-list">
          <a class="btn btn-outline-secondary" href="{{ base_path }}/runs/{{ run.id }}/export">Export</a>
          <button class="btn btn-outline-warning" type="button" id="retryFailedBtn">Retry Failed</button>
          <button class="btn btn-outline-primary" type="button" id="editConfigsBtn" {% if !run.can_edit_configs %}disabled{% endif %}>
            Edit configs
          </button>
        </div>
        <div class="text-secondary small mt-2 d-none" id="retryFailedStatus"></div>
        {% if !run.can_edit_configs %}
          <div class="text-secondary small mt-1">Configs can be edited only before jobs start.</div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="h3 m-0">{{ run.src_endpoint.name }} → {{ run.dst_endpoint.name }}</div>
        {% if run.dry_run %}
          <span class="badge bg-azure text-white">dry run</span>
        {% endif %}
        {% if run.wizard.is_some() %}
          <span class="badge bg-indigo text-white">wizard</span>
        {% endif %}
        {% if run.run_mode.as_str() == "backup" %}
          <span class="badge bg-teal text-white">backup</span>
        {% elif run.run_mode.as_str() == "restore" %}
          <span class="badge bg-indigo text-white">restore</span>
        {% endif %}
      </div>
      <div class="text-secondary mt-1">template {{ run.template.name }}</div>
      <div class="text-secondary small">
        Src prefix={{ run.src_endpoint.prefix }}, keep_alive={{ run.src_endpoint.keep_alive }}
        · Dst prefix={{ run.dst_endpoint.prefix }}, keep_alive={{ run.dst_endpoint.keep_alive }}
        · template replicas={% if run.template.number_of_replicas.is_some() %}{{ run.template.number_of_replicas.unwrap() }}{% else %}inherit{% endif %}
        · index_copy_suffix={% if run.copy_suffix.is_some() %}{{ run.copy_suffix.clone().unwrap() }}{% else %}none{% endif %}
        · alias_suffix={% if run.alias_suffix.is_some() %}{{ run.alias_suffix.clone().unwrap() }}{% else %}none{% endif %}
      </div>
    </div>
  </div>

  <div id="stagesContainer">
    {% for stage in run.stages %}
      <div class="card mb-3">
        <div class="card-header">
          <div class="card-title">{{ stage.name }}</div>
          <div class="card-actions d-flex gap-2 align-items-center">
            {% if stage.can_start %}
              <form class="js-start-stage" action="{{ base_path }}/runs/{{ run.id }}/stages/{{ stage.id }}/start" method="post">
                <button class="btn btn-primary" type="submit">Start Stage</button>
              </form>
            {% endif %}
            {% if stage.can_stop %}
              <form class="js-stop-stage" action="{{ base_path }}/runs/{{ run.id }}/stages/{{ stage.id }}/stop" method="post">
                <button class="btn btn-outline-danger" type="submit">Stop Stage</button>
              </form>
            {% endif %}
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-vcenter card-table">
            <thead>
              <tr>
                <th>Job name</th>
                <th>Status</th>
                <th>Progress</th>
                <th>ETA</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for job in stage.jobs %}
                <tr>
                  <td>
                    <div class="fw-semibold">{{ job.name }}</div>
                  </td>
                  <td>
                    {% if job.status.as_str() == "pending" %}
                      <span class="badge bg-secondary text-white status-text">pending</span>
                    {% else if job.status.as_str() == "running" %}
                      <span class="badge bg-yellow text-dark status-text">running</span>
                    {% else if job.status.as_str() == "queued" %}
                      <span class="badge bg-blue text-white status-text">queued</span>
                    {% else if job.status.as_str() == "succeeded" %}
                      <span class="badge bg-green text-dark status-text">succeeded</span>
                    {% else if job.status.as_str() == "stopped" %}
                      <span class="badge bg-secondary text-white status-text">stopped</span>
                    {% else %}
                      <span class="badge bg-red text-white status-text">failed</span>
                    {% endif %}
                  </td>
                  <td style="min-width: 200px;">
                    {% if job.progress_width.is_some() %}
                      <div class="progress">
                        <div class="progress-bar bg-blue" style="width: {{ job.progress_width.unwrap() }}%"></div>
                      </div>
                      <div class="text-secondary small mt-1">
                        {{ job.progress_label.as_deref().unwrap_or("n/a") }}
                      </div>
                    {% else %}
                      <span class="text-secondary small">-</span>
                    {% endif %}
                  </td>
                  <td class="text-secondary small">
                    {% if job.eta_label.is_some() %}
                      {{ job.eta_label.as_deref().unwrap_or("") }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="btn-list justify-content-end">
                      {% if job.status.as_str() == "running" || job.status.as_str() == "queued" %}
                        <form class="js-stop-job" action="{{ base_path }}/runs/{{ run.id }}/jobs/{{ job.id }}/stop" method="post">
                          <button class="btn btn-outline-danger" type="submit">Stop Job</button>
                        </form>
                      {% else if job.status.as_str() == "pending" || job.status.as_str() == "failed" || job.status.as_str() == "stopped" %}
                        <form class="js-start-job" action="{{ base_path }}/runs/{{ run.id }}/jobs/{{ job.id }}/start?redirect=run" method="post">
                          <button class="btn btn-outline-primary" type="submit">Start Job</button>
                        </form>
                      {% endif %}
                      <a class="btn btn-outline-secondary js-view-logs" href="{{ base_path }}/runs/{{ run.id }}/jobs/{{ job.id }}">View Logs</a>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="card-body">
          {% if stage.split_details.len() > 0 %}
            <div>
              <details class="split-details" data-stage-id="{{ stage.id }}">
                <summary>Split details</summary>
                <div class="mb-3">
                  <div class="text-secondary small">Quantile distribution</div>
                  <div class="mt-2 split-chart" data-split-chart="true" data-split-chart-values='[
                    {% for detail in stage.split_details %}
                      {% if detail.leftover == false %}["Q{{ loop.index }}", {{ detail.doc_count.unwrap_or(0) }}],{% endif %}
                    {% endfor %}
                    ["_end",0]
                  ]'></div>
                </div>
                <div class="list-group list-group-flush">
                  {% for detail in stage.split_details %}
                    <div class="list-group-item">
                      <div class="fw-semibold">{{ detail.job_name }}</div>
                      <div class="text-secondary small">
                        field={{ detail.field_name }}
                        {% if detail.leftover %} · leftover{% endif %}
                      </div>
                      <div class="text-secondary small">
                        {% if detail.date_from.is_some() %}gte={{ detail.date_from.as_deref().unwrap_or("") }}{% endif %}
                        {% if detail.date_to.is_some() %}
                          {% if detail.date_from.is_some() %} · {% endif %}
                          lt={{ detail.date_to.as_deref().unwrap_or("") }}
                        {% endif %}
                        {% if detail.leftover %}missing field{% endif %}
                        {% if detail.doc_count.is_some() %}
                          · docs={{ detail.doc_count.unwrap() }}
                        {% endif %}
                      </div>
                      {% if detail.query.is_some() %}
                        <div class="split-query-wrap mt-2">
                          <div class="split-query-header">
                            <span class="text-secondary small">ES query</span>
                            <button class="btn btn-sm btn-ghost split-copy" type="button" title="Copy to clipboard">
                              <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                              </svg>
                            </button>
                          </div>
                          <pre class="split-query">{{ detail.query.as_deref().unwrap_or("") }}</pre>
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </details>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="modal modal-blur fade" id="configEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit configs</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-4">
              <div class="text-secondary small mb-2">Files</div>
              <div class="config-editor-list" id="configFileList"></div>
            </div>
            <div class="col-md-8">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-secondary small" id="configFileMeta">Select a file to edit.</div>
                <div class="text-secondary small" id="configEditorStatus"></div>
              </div>
              <div class="config-editor-pane" id="configEditorPane"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" type="button" id="configSaveBtn" disabled>Save</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    const scrollKey = "es-copy-scroll";
    window.__basePath = "{{ base_path }}" === "/" ? "" : "{{ base_path }}";
    const basePath = window.__basePath || "";
    const editorBasePath = "{{ base_path }}" === "/" ? "" : "{{ base_path }}";
    const retryFailedBtn = document.getElementById("retryFailedBtn");
    const retryFailedStatus = document.getElementById("retryFailedStatus");
    const saved = sessionStorage.getItem(scrollKey);
    let pendingScroll = saved ? parseInt(saved, 10) || 0 : null;

    function escapeHtml(value) {
      return value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function statusBadge(status) {
      switch (status) {
        case "running":
          return `<span class="badge bg-yellow text-dark status-text">running</span>`;
        case "queued":
          return `<span class="badge bg-blue text-white status-text">queued</span>`;
        case "succeeded":
          return `<span class="badge bg-green text-dark status-text">succeeded</span>`;
        case "failed":
          return `<span class="badge bg-red text-white status-text">failed</span>`;
        case "stopped":
          return `<span class="badge bg-secondary text-white status-text">stopped</span>`;
        default:
          return `<span class="badge bg-secondary text-white status-text">pending</span>`;
      }
    }

    function renderSplitCharts() {
      document.querySelectorAll("[data-split-chart]").forEach((chartEl) => {
        const raw = chartEl.dataset.splitChartValues || "[]";
        let data = [];
        try {
          data = JSON.parse(raw);
        } catch (err) {
          data = [];
        }
        if (!data.length) {
          chartEl.innerHTML = "";
          return;
        }
        const categories = data.map((item) => item[0]);
        const values = data.map((item) => item[1]);
        if (chartEl._apexChart) {
          chartEl._apexChart.updateOptions({ xaxis: { categories } }, false, true);
          chartEl._apexChart.updateSeries([{ name: "Docs", data: values }], true);
          return;
        }
        chartEl.innerHTML = "";
        const chart = new ApexCharts(chartEl, {
          chart: {
            type: "bar",
            height: 160,
            toolbar: { show: false },
            animations: { enabled: false },
            background: "transparent",
          },
          theme: { mode: "dark" },
          plotOptions: {
            bar: { columnWidth: "55%", borderRadius: 4 },
          },
          grid: { borderColor: "rgba(255, 255, 255, 0.1)" },
          dataLabels: { enabled: false },
          colors: ["#4dabf7"],
          xaxis: { categories, title: { text: "Quantile" } },
          yaxis: { title: { text: "Docs" } },
          series: [{ name: "Docs", data: values }],
        });
        chart.render();
        chartEl._apexChart = chart;
      });
    }

    function renderStages(run) {
      const container = document.getElementById("stagesContainer");
      if (!container) {
        return;
      }
      const scrollY = window.scrollY;
      const scrollX = window.scrollX;
      const previousScrollBehavior = document.documentElement.style.scrollBehavior;
      const openSplits = new Set(
        Array.from(document.querySelectorAll("details.split-details[open]"))
          .map((detail) => detail.getAttribute("data-stage-id"))
          .filter(Boolean),
      );
      container.innerHTML = run.stages
        .map((stage) => {
          const splitDetails = Array.isArray(stage.split_details) ? stage.split_details : [];
          const jobs = stage.jobs
            .map((job) => {
              const progress = job.progress_width !== null && job.progress_width !== undefined
                ? `
                    <div class="progress">
                      <div class="progress-bar bg-blue" style="width: ${job.progress_width}%"></div>
                    </div>
                    <div class="text-secondary small mt-1">
                      ${job.progress_label || "n/a"}
                    </div>`
                : `<span class="text-secondary small">-</span>`;
              const eta = job.eta_label ? `<span class="text-secondary small">${job.eta_label}</span>` : `<span class="text-secondary small">-</span>`;
              const stopButton = (job.status === "running" || job.status === "queued")
                ? `
                    <form class="js-stop-job" action="${basePath}/runs/${run.id}/jobs/${job.id}/stop" method="post">
                      <button class="btn btn-outline-danger" type="submit">Stop Job</button>
                    </form>`
                : "";
              const startButton = (job.status === "pending" || job.status === "failed" || job.status === "stopped")
                ? `
                    <form class="js-start-job" action="${basePath}/runs/${run.id}/jobs/${job.id}/start?redirect=run" method="post">
                      <button class="btn btn-outline-primary" type="submit">Start Job</button>
                    </form>`
                : "";
              return `
                <tr>
                  <td>
                    <div class="fw-semibold">${escapeHtml(job.name)}</div>
                  </td>
                  <td>${statusBadge(job.status)}</td>
                  <td style="min-width: 200px;">${progress}</td>
                  <td>${eta}</td>
                  <td class="text-end">
                    <div class="btn-list justify-content-end">
                      ${startButton}
                      ${stopButton}
                      <a class="btn btn-outline-secondary js-view-logs" href="${basePath}/runs/${run.id}/jobs/${job.id}">View Logs</a>
                    </div>
                  </td>
                </tr>`;
            })
            .join("");
          const startStageButton = stage.can_start
            ? `
                <form class="js-start-stage" action="${basePath}/runs/${run.id}/stages/${stage.id}/start" method="post">
                  <button class="btn btn-primary" type="submit">Start Stage</button>
                </form>`
            : "";
          const stopStageButton = stage.can_stop
            ? `
                <form class="js-stop-stage" action="${basePath}/runs/${run.id}/stages/${stage.id}/stop" method="post">
                  <button class="btn btn-outline-danger" type="submit">Stop Stage</button>
                </form>`
            : "";
          const splitHtml = splitDetails.length
            ? `
              <div class="card-body">
                <details class="split-details" data-stage-id="${escapeHtml(stage.id)}">
                  <summary>Split details</summary>
                  <div class="mb-3">
                    <div class="text-secondary small">Quantile distribution</div>
                    <div class="mt-2 split-chart" data-split-chart="true" data-split-chart-values=""></div>
                  </div>
                  <div class="list-group list-group-flush">
                    ${splitDetails
                      .map((detail) => {
                        const from = detail.date_from ? `gte=${escapeHtml(detail.date_from)}` : "";
                        const to = detail.date_to ? `lt=${escapeHtml(detail.date_to)}` : "";
                        const range = [from, to].filter(Boolean).join(" · ");
                        const extra = detail.leftover ? "missing field" : "";
                        const meta = [range, extra].filter(Boolean).join(" · ");
                        const query = detail.query
                          ? `
                              <div class="split-query-wrap mt-2">
                                <div class="split-query-header">
                                  <span class="text-secondary small">ES query</span>
                                  <button class="btn btn-sm btn-ghost split-copy" type="button" title="Copy to clipboard">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                      <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                                      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                  </button>
                                </div>
                                <pre class="split-query">${escapeHtml(detail.query)}</pre>
                              </div>`
                          : "";
                        const count = detail.doc_count !== null && detail.doc_count !== undefined
                          ? ` · docs=${detail.doc_count}`
                          : "";
                        return `
                          <div class="list-group-item">
                            <div class="fw-semibold">${escapeHtml(detail.job_name)}</div>
                            <div class="text-secondary small">
                              field=${escapeHtml(detail.field_name)}${detail.leftover ? " · leftover" : ""}
                            </div>
                            <div class="text-secondary small">${meta}${count}</div>
                            ${query}
                          </div>`;
                      })
                      .join("")}
                  </div>
                </details>
              </div>`
            : "";
          return `
            <div class="card mb-3">
              <div class="card-header">
                <div class="card-title">${stage.name}</div>
                <div class="card-actions d-flex gap-2 align-items-center">
                  ${startStageButton}
                  ${stopStageButton}
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-vcenter card-table">
                  <thead>
                    <tr>
                      <th>Job name</th>
                      <th>Status</th>
                      <th>Progress</th>
                      <th>ETA</th>
                      <th class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${jobs}
                  </tbody>
                </table>
              </div>
              ${splitHtml}
            </div>`;
        })
        .join("");
      container.querySelectorAll("details.split-details").forEach((detail) => {
        const stageId = detail.getAttribute("data-stage-id");
        const chartEl = detail.querySelector("[data-split-chart]");
        if (chartEl) {
          const stage = run.stages.find((value) => value.id === stageId);
          const splitDetails = stage && Array.isArray(stage.split_details) ? stage.split_details : [];
          const chartData = splitDetails
            .filter((item) => !item.leftover)
            .map((item, index) => [`Q${index + 1}`, item.doc_count || 0]);
          chartEl.dataset.splitChartValues = JSON.stringify(chartData);
        }
      });
      renderSplitCharts();
      openSplits.forEach((id) => {
        const detail = container.querySelector(
          `details.split-details[data-stage-id="${CSS.escape(id)}"]`,
        );
        if (detail) {
          detail.open = true;
        }
      });
      document.documentElement.style.scrollBehavior = "auto";
      window.scrollTo(scrollX, scrollY);
      document.documentElement.style.scrollBehavior = previousScrollBehavior;
    }

    async function fetchRetryFailed() {
      if (!retryFailedBtn || !retryFailedStatus) return;
      retryFailedBtn.disabled = true;
      retryFailedStatus.classList.remove("d-none");
      retryFailedStatus.textContent = "Retrying failed jobs...";
      try {
        const response = await fetch(`${basePath}/runs/{{ run.id }}/retry-failed`, { method: "POST" });
        const text = await response.text();
        retryFailedStatus.textContent = text || "Retry request sent.";
      } catch (_) {
        retryFailedStatus.textContent = "Retry request failed.";
      } finally {
        retryFailedBtn.disabled = false;
      }
    }

    retryFailedBtn?.addEventListener("click", fetchRetryFailed);

    document.addEventListener("click", (event) => {
      const copyBtn = event.target.closest(".split-copy");
      if (!copyBtn) return;
      const queryEl = copyBtn.closest(".split-query-wrap")?.querySelector(".split-query");
      if (!queryEl) return;
      navigator.clipboard.writeText(queryEl.textContent || "");
    });

    if (pendingScroll !== null) {
      window.scrollTo(0, pendingScroll);
    }
    window.addEventListener("scroll", () => {
      sessionStorage.setItem(scrollKey, `${window.scrollY}`);
    });

    const stream = new EventSource(`${basePath}/runs/{{ run.id }}/stream`);
    stream.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data && data.id) {
          renderStages(data);
        }
      } catch (_) {}
    };
  </script>
  <script>
    const editConfigsBtn = document.getElementById("editConfigsBtn");
    const configModalEl = document.getElementById("configEditorModal");
    const configFileList = document.getElementById("configFileList");
    const configFileMeta = document.getElementById("configFileMeta");
    const configEditorPane = document.getElementById("configEditorPane");
    const configSaveBtn = document.getElementById("configSaveBtn");
    const configEditorStatus = document.getElementById("configEditorStatus");
    const runId = "{{ run.id }}";
    const configBase = `${window.__basePath || ""}/runs/${runId}/configs`;
    let editorView = null;
    let currentFile = null;
    let editable = {% if run.can_edit_configs %}true{% else %}false{% endif %};

    function escapeHtml(value) {
      return value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function setStatus(message, type = "muted") {
      configEditorStatus.className = `text-${type} small`;
      configEditorStatus.textContent = message;
    }

    function setMeta(message) {
      configFileMeta.textContent = message;
    }

    function ensureEditor(content) {
      if (editorView) {
        editorView.setValue(content);
        editorView.setOption("readOnly", !editable);
        return;
      }
      editorView = CodeMirror(configEditorPane, {
        value: content,
        mode: "toml",
        theme: "material-darker",
        lineNumbers: true,
        lineWrapping: true,
        readOnly: !editable,
      });
    }

    async function loadConfigList() {
      configFileList.innerHTML = "";
      setMeta("Loading...");
      setStatus("");
      const response = await fetch(configBase);
      if (!response.ok) {
        setMeta("Failed to load config list.");
        return;
      }
      const data = await response.json();
      editable = data.editable;
      if (!editable) {
        setStatus("Read-only: jobs already started.", "warning");
      }
      const files = data.files || [];
      if (!files.length) {
        setMeta("No config files found.");
        return;
      }
      setMeta("Select a file to edit.");
      files.forEach((file, index) => {
        const item = document.createElement("button");
        item.type = "button";
        item.className = "config-file-item";
        item.dataset.fileName = file.name;
        item.textContent = file.name;
        item.title = file.name;
        item.addEventListener("click", () => selectConfigFile(file, item));
        configFileList.appendChild(item);
        if (index === 0) {
          selectConfigFile(file, item);
        }
      });
    }

    async function selectConfigFile(file, itemEl) {
      const name = file.name;
      currentFile = name;
      configSaveBtn.disabled = !editable;
      document.querySelectorAll(".config-editor-list .config-file-item").forEach((el) => {
        el.classList.toggle("active", el === itemEl);
      });
      setMeta(`Editing ${name}`);
      setStatus("Loading...");
      const response = await fetch(`${configBase}/${encodeURIComponent(name)}`);
      if (!response.ok) {
        setStatus("Failed to load config.", "danger");
        return;
      }
      const content = await response.text();
      ensureEditor(content);
      setStatus("");
    }

    async function saveCurrentConfig() {
      if (!currentFile || !editorView || !editable) {
        return;
      }
      setStatus("Saving...");
      const response = await fetch(`${configBase}/${encodeURIComponent(currentFile)}`, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: editorView.getValue(),
      });
      if (!response.ok) {
        const message = await response.text();
        setStatus(message || "Failed to save.", "danger");
        return;
      }
      setStatus("Saved.", "success");
      setTimeout(() => setStatus(""), 1500);
    }

    if (editConfigsBtn && configModalEl) {
      editConfigsBtn.addEventListener("click", () => {
        const modal = bootstrap.Modal.getOrCreateInstance(configModalEl);
        modal.show();
        loadConfigList();
      });
    }

    if (configSaveBtn) {
      configSaveBtn.addEventListener("click", () => saveCurrentConfig());
    }
  </script>
{% endblock %}
